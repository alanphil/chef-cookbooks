Description
===========

Installs and configures Piwigo, a web based (LAMP) image gallery.  http://piwigo.org/

Requirements
============

* Linux
* Apache 2+
* Mysql 5+
* PHP 5.2+

http://piwigo.org/basics/requirements

Platform
--------

* Ubuntu 12.04+
* Debian 7.0+

Cookbooks
---------

Requires Opscode's openssl, mysql, database, php, ark, certificate, and apache2 cookbooks.  See _Attributes_ and _Usage_ for more information.

Attributes
==========

Database Attributes
-------------------

* `node['piwigo']['dbname']` - MySQL Database name to use for this piwigo installation (defaults to "piwigodb")
* `node['piwigo']['dbuser']` - Username piwigo will use when communicating with a local or remote MySQL server (defaults to "piwigouser")
* `node['piwigo']['dbpass']` - Gallery user's MySQL database password randomly generated by OpenSSL
* `node['piwigo']['dbhost']` - Hostname piwigo will use when communicating with a local or remote MySQL server (defaults to "localhost")
* `node['piwigo']['dbrole']` - Chef role name the piwigo cookbook can search to get node data for a remote MySQL database server, only applies when `node['piwigo']['uselocalmysqld]` is false
* `node['piwigo']['userlocalmysqld']` - Set this attribute to true if you want to install a local instance of mysqld on the same server that will run piwigo.  If set to false you will need to modify other piwigo database attributes to point at the remote database server

Web/Apache/SSL Attributes
-------------------------

* `node['piwigo']['wwwname']` - Hostname users will use to reach this piwigo installation (default is "piwigo3.example.com")
* `node['piwigo']['wwwdir']` - The install directory which is also served via Apache2 (defaults to "/var/www/piwigo")
* `node['piwigo']['adminemail']` - Email address of the piwigo site administrator (defaults to "postmaster@example.com")
* `node['piwigo']['webserver_apache2']` - Toggle whether to install and configure Apache2 for the Gallery install or to perform no webserver installation at all (default is "true" to install Apache2)
* `node['piwigo']['adminpass']` - Randomly generated password credentials for the 'admin' user in the  Gallery Administrative Web UI.  This is a local non-LDAP account created inside the piwigodb during piwigo installation
* `node['piwigo']['apachessl']` - Toggle between using SSL/HTTPS or not.  Recommended for live/production authentication however by default SSL/HTTPS will not be used for easy testing without getting bogged down with certificate management (default is false)
* `node['piwigo']['sslcertmode']` - The mode 'none' skips any kind of certificate management, 'default', 'wildcard', and 'manage_by_attributes' all behave as recipes in the http://community.opscode.com/cookbooks/certificate cookbook. (default is none)
* `node['piwigo']['sslcertfile']` - The PEM formatted SSL certificate file used in HTTPS communications (default is "/etc/ssl/certs/#{node[:fqdn]}.pem")
* `node['piwigo']['sslkeyfile']` - The SSL certificate private key file used in HTTPS communications (default is "/etc/ssl/private/#{node[:fqdn]}.key")
* `node['piwigo']['sslchainfile']` - The PEM formatted SSL certificate file used in HTTPS communications to complete the chain of trust between web browsers, web servers, and your chosen Certificate Authorities (default is "/etc/ssl/certs/#{node[:hostname]}-bundle.crt")

Gallery Core and Contrib Install Attributes
-------------------------------------------

* `node['piwigo']['version']` - The current piwigo version being managed (default is "3.0.9")
* `node['piwigo']['zipurl']` - HTTP URL for Gallery 3 install files (default is "https://github.com/piwigo/piwigo3/archive/3.0.x.zip")

PHP Image/File Upload Attributes
--------------------------------

* `node['piwigo']['php']['upload_max_filesize']` - The PHP directive to limit the maximum size of an uploaded file (default is "256M")
* `node['piwigo']['php']['memory_limit']` - The PHP directive to limit the amount of memory in bytes that a script is allowed to allocate (default is "512M")
* `node['piwigo']['php']['post_max_size']` - The PHP directive to limit the post data allowed (default is "256M")
* `node['piwigo']['php']['max_file_uploads']` - The PHP directive to set the number of allowed simultaneus uploads (default "25")

* `node['piwigo']['ldapmodule']['allgroups']` - Fill this array with all of the LDAP groups you want to be mapped to piwigo groups.  At a minimum you might want to have 1 non-authenticated user group (an 'everybody group') and 1 registered users group (default is [ " Administrators", "Guest" ])

* `node['piwigo']['ldapmodule']['everybody_group']` - Often a 'guest' type group, this is used by non-authenticated users (default is "Guest")
* `node['piwigo']['ldapmodule']['regusergroup']` - Any members of this LDAP group are deemed 'registered' by Gallery (default is "Administrators")
* `node['piwigo']['ldapmodule']['adminusers']` - Any LDAP users listed in this array are granted full administrative privileges to Gallery.  Note activation of the LDAP module completely disables the local piwigoadmin user (default is [ "joe", "bob" ] )
* `node['piwigo']['ldapmodule']['ldaphost']` - LDAP protocol URI to the LDAP server's hostname or ip address (default is "ldaps://ldap1.example.com")
* `node['piwigo']['ldapmodule']['groupdn']` - Distinguished Name for setting LDAP Group Search Scope (default is "ou=Groups,dc=example,dc=com")
* `node['piwigo']['ldapmodule']['userdn']` - Distinguished Name for setting LDAP User Search Scope (default is "ou=People,dc=example,dc=com")

Data Bags and Encryption
========================

If `node['piwigo']['sslcertmode']` is set to 'none' (the default) no encrypted data bags or certificate deployment will occur.  Use this if you want to manage certificate deploys some other way than the certificate cookbook.

Any other sslcertmode will use the certificate cookbook for certificate deploys in a 'default', 'wildcard', and 'managed by attributes' recipes which depend on encrypted data bags as documented here http://community.opscode.com/cookbooks/certificate

The certificate cookbook does not create any certificates, it just deploys certs, keys, and chain files stored in encrypted data bags.  Note that when bootstrapping new servers that use the certificate cookbook for ssl certificate deployment you will need to copy the `encrypted_key_file` to both the server and any knife management clients that update the certificates

Usage
=====

`recipe[piwigo]` in your `run_list` should build a stand-alone Gallery installation.

It is recommended to make a role which includes `recipe[piwigo]` and sets `override_attributes` for the wwwname attribute at a minimum.  Once Gallery is installed use knife to examine the node data for the Gallery server 'knife node show piwigo3.example.com -Fj' and look for the `node['piwigo']['adminpass']`.  Now login as 'admin' with the node data adminpass.

Below is a more complex config that deploys an unlimited wildcard ssl certificate/key/CA chain files from an encrypted data bag and also configures anonymous bind openldap LDAP/ssl authentication

    $ cat roles/piwigo.json
    {
      name: "piwigo",
      description: "Apache2 Web Gallery",
      run_list: [
      "recipe[piwigo]"
      ],
      override_attributes": {
        "piwigo": {
          "wwwname": "piwigo3.example.com",
          "adminemail": "postmaster@example.com",
          "apachessl": true,
          "sslcertmode": "wildcard",
          "ldapmodule": {
            "allgroups": [ "sysadmin", "guest" ],
            "regusergroup": "sysadmin",
            "everybody_group": "guest",
            "adminusers": [ "joe", "bob" ],
            "ldaphost": "ldaps://ldap.domain.com/",
            "userdn": "ou=People,dc=domain,dc=com",
            "groupdn": "ou=Groups,dc=domain,dc=com"
          }
        }
      }
    )

License and Authors
===================
* Author:: Ian Garrison <garrison@technoendo.net>
* Author:: Pauly Comtois

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at 

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
